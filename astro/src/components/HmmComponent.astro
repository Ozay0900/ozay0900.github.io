---
import { hmm } from '../utils/hmm.js';
---

<div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: system-ui, -apple-system, sans-serif;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #333;">Simple Hidden Markov Model</h2>
    </div>

    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 50px; margin-top: 50px">
        cool and stylish visualization of hmms will be here soon
    </div>

    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
        <div style="display: flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 8px;">
            <button id="scatter-no-color" style="padding: 8px 16px; border: none; background: #2563eb; color: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                Scatter
            </button>
            <button id="scatter-color" style="padding: 8px 16px; border: none; background: transparent; color: #64748b; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                Scatter (Colored)
            </button>
            <button id="line-no-color" style="padding: 8px 16px; border: none; background: transparent; color: #64748b; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                Line
            </button>
            <button id="line-color" style="padding: 8px 16px; border: none; background: transparent; color: #64748b; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                Line (Colored)
            </button>
        </div>
    </div>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Transition γ₁₂: <span id="gamma12-value" style="color: #2563eb; font-weight: 600;">0.10</span>
                </label>
                <input type="range" id="gamma12" min="0" max="1" step="0.01" value="0.1"
                       style="width: 100%; accent-color: #2563eb;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Transition γ₂₁: <span id="gamma21-value" style="color: #2563eb; font-weight: 600;">0.20</span>
                </label>
                <input type="range" id="gamma21" min="0" max="1" step="0.01" value="0.2"
                       style="width: 100%; accent-color: #2563eb;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Mean μ₁: <span id="mu1-value" style="color: #2563eb; font-weight: 600;">10.0</span>
                </label>
                <input type="range" id="mu1" min="-10" max="20" step="0.5" value="10"
                       style="width: 100%; accent-color: #2563eb;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Mean μ₂: <span id="mu2-value" style="color: #dc2626; font-weight: 600;">2.0</span>
                </label>
                <input type="range" id="mu2" min="-10" max="20" step="0.5" value="2"
                       style="width: 100%; accent-color: #dc2626;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Std Dev σ₁: <span id="sigma1-value" style="color: #2563eb; font-weight: 600;">2.0</span>
                </label>
                <input type="range" id="sigma1" min="0.1" max="5" step="0.1" value="2"
                       style="width: 100%; accent-color: #2563eb;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Std Dev σ₂: <span id="sigma2-value" style="color: #dc2626; font-weight: 600;">1.0</span>
                </label>
                <input type="range" id="sigma2" min="0.1" max="5" step="0.1" value="1"
                       style="width: 100%; accent-color: #dc2626;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Time Steps T: <span id="t-value" style="color: #059669; font-weight: 600;">1000</span>
                </label>
                <input type="range" id="t" min="100" max="5000" step="100" value="1000"
                       style="width: 100%; accent-color: #059669;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">
                    Random Seed: <span id="seed-value" style="color: #7c3aed; font-weight: 600;">42</span>
                </label>
                <input type="number" id="seed" min="0" max="99999" value="42"
                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <canvas id="chart" width="1100" height="500" style="display: block;"></canvas>
    </div>

    <div id="legend" style="margin-top: 15px; display: flex; gap: 20px; justify-content: center;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 16px; height: 16px; background: #2563eb; border-radius: 50%;"></div>
            <span style="color: #555;">State 1</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 16px; height: 16px; background: #dc2626; border-radius: 50%;"></div>
            <span style="color: #555;">State 2</span>
        </div>
    </div>
</div>

<script>
    // TODO: Add cool interactive plots for the extensions (covariates, numerical optimization,
    import { hmm } from '../utils/hmm.js';

    let plotMode: 'scatter-no-color' | 'scatter-color' | 'line-no-color' | 'line-color' = 'scatter-no-color';


    let cachedData: { s_t: number[], x_t: number[] } | null = null;
    let lastParams: string = '';

    function getParamsKey() {
        const gamma12El = document.getElementById('gamma12') as HTMLInputElement;
        const gamma21El = document.getElementById('gamma21') as HTMLInputElement;
        const mu1El = document.getElementById('mu1') as HTMLInputElement;
        const mu2El = document.getElementById('mu2') as HTMLInputElement;
        const sigma1El = document.getElementById('sigma1') as HTMLInputElement;
        const sigma2El = document.getElementById('sigma2') as HTMLInputElement;
        const tEl = document.getElementById('t') as HTMLInputElement;
        const seedEl = document.getElementById('seed') as HTMLInputElement;

        if (!gamma12El || !gamma21El || !mu1El || !mu2El || !sigma1El || !sigma2El || !tEl || !seedEl) return '';

        return `${gamma12El.value}-${gamma21El.value}-${mu1El.value}-${mu2El.value}-${sigma1El.value}-${sigma2El.value}-${tEl.value}-${seedEl.value}`;
    }

    function plotHMM(regenerate: boolean = false) {
        const gamma12El = document.getElementById('gamma12') as HTMLInputElement;
        const gamma21El = document.getElementById('gamma21') as HTMLInputElement;
        const mu1El = document.getElementById('mu1') as HTMLInputElement;
        const mu2El = document.getElementById('mu2') as HTMLInputElement;
        const sigma1El = document.getElementById('sigma1') as HTMLInputElement;
        const sigma2El = document.getElementById('sigma2') as HTMLInputElement;
        const tEl = document.getElementById('t') as HTMLInputElement;
        const seedEl = document.getElementById('seed') as HTMLInputElement;
        const canvas = document.getElementById("chart") as HTMLCanvasElement;
        const legend = document.getElementById("legend");

        if (!gamma12El || !gamma21El || !mu1El || !mu2El || !sigma1El || !sigma2El || !tEl || !seedEl || !canvas) return;

        const gamma_12 = parseFloat(gamma12El.value);
        const gamma_21 = parseFloat(gamma21El.value);
        const mu1 = parseFloat(mu1El.value);
        const mu2 = parseFloat(mu2El.value);
        const sigma1 = parseFloat(sigma1El.value);
        const sigma2 = parseFloat(sigma2El.value);
        const T = parseInt(tEl.value);
        const seed = parseInt(seedEl.value);

        const currentParams = getParamsKey();


        if (regenerate || currentParams !== lastParams || !cachedData) {
            const mu = [mu1, mu2];
            const sigma = [sigma1, sigma2];
            const tpm = [
                [1 - gamma_12, gamma_12],
                [gamma_21, 1 - gamma_21],
            ];

            const [s_t, x_t] = hmm(tpm, T, mu, sigma);
            cachedData = { s_t, x_t };
            lastParams = currentParams;
        }

        const { s_t, x_t } = cachedData;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const width = canvas.width;
        const height = canvas.height;
        const padding = 60;
        const plotWidth = width - 2 * padding;
        const plotHeight = height - 2 * padding;

        const min = Math.min(...x_t);
        const max = Math.max(...x_t);
        const range = max - min;


        if (legend) {
            legend.style.display = (plotMode === 'scatter-color' || plotMode === 'line-color') ? 'flex' : 'none';
        }


        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, width, height);


        ctx.strokeStyle = "#e5e7eb";
        ctx.lineWidth = 1;

        for (let i = 0; i <= 10; i++) {
            const y = padding + (i / 10) * plotHeight;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
        }

        for (let i = 0; i <= 10; i++) {
            const x = padding + (i / 10) * plotWidth;
            ctx.beginPath();
            ctx.moveTo(x, padding);
            ctx.lineTo(x, height - padding);
            ctx.stroke();
        }


        ctx.strokeStyle = "#374151";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.stroke();


        ctx.fillStyle = "#374151";
        ctx.font = "12px system-ui, sans-serif";
        ctx.textAlign = "right";
        for (let i = 0; i <= 5; i++) {
            const y = padding + (i / 5) * plotHeight;
            const value = max - (i / 5) * range;
            ctx.fillText(value.toFixed(1), padding - 10, y + 4);
        }


        ctx.textAlign = "center";
        for (let i = 0; i <= 5; i++) {
            const x = padding + (i / 5) * plotWidth;
            const value = Math.round((i / 5) * T);
            ctx.fillText(value.toString(), x, height - padding + 20);
        }


        ctx.fillStyle = "#1f2937";
        ctx.font = "bold 14px system-ui, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("Time Step (t)", width / 2, height - 10);

        ctx.save();
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText("Observation Value", 0, 0);
        ctx.restore();


        if (plotMode === 'line-no-color') {

            ctx.strokeStyle = "#64748b";
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let t = 0; t < T; t++) {
                const x = padding + (t / (T - 1)) * plotWidth;
                const y = height - padding - ((x_t[t] - min) / range) * plotHeight;

                if (t === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

        } else if (plotMode === 'line-color') {
            ctx.lineWidth = 2;

            for (let t = 0; t < T - 1; t++) {
                const x1 = padding + (t / (T - 1)) * plotWidth;
                const y1 = height - padding - ((x_t[t] - min) / range) * plotHeight;
                const x2 = padding + ((t + 1) / (T - 1)) * plotWidth;
                const y2 = height - padding - ((x_t[t + 1] - min) / range) * plotHeight;

                ctx.strokeStyle = s_t[t] === 1 ? "#dc2626" : "#2563eb";

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

        } else if (plotMode === 'scatter-no-color') {
            ctx.fillStyle = "#64748b";

            for (let t = 0; t < T; t++) {
                const x = padding + (t / (T - 1)) * plotWidth;
                const y = height - padding - ((x_t[t] - min) / range) * plotHeight;

                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, 2 * Math.PI);
                ctx.fill();
            }

        } else if (plotMode === 'scatter-color') {
            for (let t = 0; t < T; t++) {
                const x = padding + (t / (T - 1)) * plotWidth;
                const y = height - padding - ((x_t[t] - min) / range) * plotHeight;

                ctx.fillStyle = s_t[t] === 1 ? "#dc2626" : "#2563eb";

                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
    }

    function setPlotMode(mode: 'scatter-no-color' | 'scatter-color' | 'line-no-color' | 'line-color') {
        plotMode = mode;

        const buttons = {
            'scatter-no-color': document.getElementById('scatter-no-color'),
            'scatter-color': document.getElementById('scatter-color'),
            'line-no-color': document.getElementById('line-no-color'),
            'line-color': document.getElementById('line-color')
        };

        Object.entries(buttons).forEach(([key, btn]) => {
            if (btn) {
                if (key === mode) {
                    btn.style.background = '#2563eb';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#64748b';
                }
            }
        });

        plotHMM(false);
    }

    function setupSlider(id: string, valueId: string, decimals: number = 2) {
        const slider = document.getElementById(id) as HTMLInputElement;
        const display = document.getElementById(valueId);

        if (!slider || !display) return;

        slider.addEventListener('input', (e) => {
            const value = parseFloat((e.target as HTMLInputElement).value);
            display.textContent = value.toFixed(decimals);
            plotHMM(true);
        });
    }


    document.getElementById('scatter-no-color')?.addEventListener('click', () => setPlotMode('scatter-no-color'));
    document.getElementById('scatter-color')?.addEventListener('click', () => setPlotMode('scatter-color'));
    document.getElementById('line-no-color')?.addEventListener('click', () => setPlotMode('line-no-color'));
    document.getElementById('line-color')?.addEventListener('click', () => setPlotMode('line-color'));


    const seedEl = document.getElementById('seed') as HTMLInputElement;
    const seedDisplay = document.getElementById('seed-value');
    if (seedEl && seedDisplay) {
        seedEl.addEventListener('input', (e) => {
            const value = parseInt((e.target as HTMLInputElement).value);
            seedDisplay.textContent = value.toString();
            plotHMM(true);
        });
    }

    setupSlider('gamma12', 'gamma12-value', 2);
    setupSlider('gamma21', 'gamma21-value', 2);
    setupSlider('mu1', 'mu1-value', 1);
    setupSlider('mu2', 'mu2-value', 1);
    setupSlider('sigma1', 'sigma1-value', 1);
    setupSlider('sigma2', 'sigma2-value', 1);
    setupSlider('t', 't-value', 0);

    plotHMM(true);
</script>